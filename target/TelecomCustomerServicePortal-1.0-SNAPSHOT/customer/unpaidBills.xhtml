<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui">

    <!-- ====================================================== -->
    <!-- CLEAR MESSAGE ONLY ON PAGE LOAD (NOT AJAX)            -->
    <!-- ====================================================== -->
    <f:metadata>
        <f:event type="preRenderView" listener="#{customerBillingBean.preRender}" />
    </f:metadata>

    <style>
        .main-content {
            max-width: 1100px;
            margin: 0 auto;
            padding: 10px 20px;
        }
        @media (max-width: 576px) {
            .main-content { padding: 15px 10px; }
        }
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        th, td {
            white-space: nowrap;
            vertical-align: middle;
        }
        .action-btn { width: 100%; }

        .payment-header {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
    </style>

    <div class="main-content">

        <!-- PRIMEFACES GROWL -->
        <p:growl id="msgGrowl" showDetail="true" life="4000" />

        <!-- ============================ -->
        <!-- GLOBAL MESSAGES BOX         -->
        <!-- ============================ -->
        <h:panelGroup id="msgArea">
            <ui:fragment rendered="#{not empty customerBillingBean.message}">
                <div class="alert alert-#{customerBillingBean.messageType} alert-dismissible fade show">
                    <strong>
                        <ui:fragment rendered="#{customerBillingBean.messageType eq 'success'}">
                            Success:
                        </ui:fragment>
                        <ui:fragment rendered="#{customerBillingBean.messageType ne 'success'}">
                            Error:
                        </ui:fragment>
                    </strong>
                    #{customerBillingBean.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </ui:fragment>
        </h:panelGroup>

        <div class="card shadow-sm mt-2">
            <div class="card-body">

                <div class="table-responsive">

                    <h:panelGroup id="unpaidTable">

                        <table class="table table-hover table-bordered align-middle">

                            <thead class="table-dark">
                                <tr>
                                    <th>Service Name</th>
                                    <th>Amount (KES)</th>
                                    <th>Billing Date</th>
                                    <th style="width:150px;">Action</th>
                                </tr>
                            </thead>

                            <tbody>

                                <!-- UNPAID LIST -->
                                <ui:fragment rendered="#{not empty customerBillingBean.unpaidList}">
                                    <ui:repeat var="bill" value="#{customerBillingBean.unpaidList}">
                                        <tr>
                                            <td>#{bill.serviceName}</td>
                                            <td>#{bill.amount}</td>

                                            <td>
                                                <h:outputText value="#{bill.billingDate}">
                                                    <f:convertDateTime pattern="yyyy-MM-dd HH:mm" />
                                                </h:outputText>
                                            </td>

                                            <td class="text-center">

                                                <!-- Unique form inside repeat -->
                                                <h:form id="payForm_#{bill.id}">
                                                    <p:commandButton 
                                                        value="Pay Now"
                                                        styleClass="btn btn-sm btn-success action-btn"
                                                        process="@this"
                                                        update=":paymentForm"
                                                        oncomplete="PF('paymentDlg').show(); $('#phone').focus();">

                                                        <f:setPropertyActionListener 
                                                            value="#{bill}" 
                                                            target="#{customerBillingBean.selectedBill}" />
                                                    </p:commandButton>
                                                </h:form>

                                            </td>
                                        </tr>
                                    </ui:repeat>
                                </ui:fragment>

                                <!-- EMPTY LIST -->
                                <ui:fragment rendered="#{empty customerBillingBean.unpaidList}">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-3">
                                            No unpaid bills found.
                                        </td>
                                    </tr>
                                </ui:fragment>

                            </tbody>
                        </table>

                    </h:panelGroup>

                </div>

            </div>
        </div>

    </div>

    <!-- ====================================================== -->
    <!-- PAYMENT MODAL                                         -->
    <!-- ====================================================== -->
    <p:dialog id="paymentDialog"
              header="Confirm Payment"
              widgetVar="paymentDlg"
              modal="true" resizable="false"
              draggable="false" closable="true"
              width="420">

        <h:form id="paymentForm">

            <div class="payment-header mb-3">M-PESA Payment</div>

            <h:panelGrid columns="2" columnClasses="label,value" cellpadding="6">

                <h:outputLabel value="Service Name:" />
                <h:outputText value="#{customerBillingBean.selectedBill.serviceName}" />

                <h:outputLabel value="Amount (KES):" />
                <h:outputText value="#{customerBillingBean.selectedBill.amount}" />

                <h:outputLabel for="phone" value="Phone Number:" />
                <p:inputText id="phone"
                             value="#{customerBillingBean.customerPhone}"
                             required="true"
                             placeholder="2547XXXXXXXX"
                             style="width:100%;" />
            </h:panelGrid>

            <div class="mt-3 d-flex gap-2">

                <p:commandButton value="Pay"
                    action="#{customerBillingBean.initiateMpesaPayment}"
                    update=":msgGrowl, :msgArea, :unpaidTable"
                    onstart="PF('paymentDlg').block();"
                    oncomplete="PF('paymentDlg').unblock(); PF('paymentDlg').hide();"
                    styleClass="btn btn-success w-100" />

                <p:commandButton value="Cancel"
                    onclick="PF('paymentDlg').hide();"
                    type="button"
                    styleClass="btn btn-secondary w-100" />

            </div>

        </h:form>

    </p:dialog>

</ui:composition>
